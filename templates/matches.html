{% extends "base.html" %}
{% block content %}
<!-- Add Match Button -->
<button type="button" class="btn btn-success mb-4" data-bs-toggle="modal" data-bs-target="#addMatchModal">Add New Match</button>

<!-- Add Match Modal -->
<div class="modal fade" id="addMatchModal" tabindex="-1" aria-labelledby="addMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{{ url_for('matches.add') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Match</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="d-flex justify-content-around align-items-center mb-3">
                        <!-- Player 1 -->
                        <div>
                            <img id="player1Logo" src="{{ url_for('static', filename='default_logo.png') }}" 
                                 alt="Player 1" style="height:80px; width:80px; border-radius:50%; object-fit:cover;">
                            <select class="form-select mt-2" id="player1Select" name="player_1" required>
                                <option value="">Select Player 1</option>
                                {% for p in participants %}
                                <option value="{{ p.id }}" data-logo="{{ url_for('static', filename='uploads/logos/' ~ p.team_logo) }}">{{ p.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="fw-bold mt-4">VS</div>

                        <!-- Player 2 -->
                        <div>
                            <img id="player2Logo" src="{{ url_for('static', filename='default_logo.png') }}" 
                                 alt="Player 2" style="height:80px; width:80px; border-radius:50%; object-fit:cover;">
                            <select class="form-select mt-2" id="player2Select" name="player_2" required>
                                <option value="">Select Player 2</option>
                                {% for p in participants %}
                                <option value="{{ p.id }}" data-logo="{{ url_for('static', filename='uploads/logos/' ~ p.team_logo) }}">{{ p.team_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Game Selection -->
                    <div class="mt-3 text-start">
                        <label class="form-label">Game</label>
                        <select class="form-select" name="game_id" required>
                            <option value="">Select Game</option>
                            {% for g in games %}
                            <option value="{{ g.id }}">{{ g.game_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Match</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Matches Table -->
<h2 class="mt-5">Matches</h2>
<table class="table table-striped table-hover shadow-sm align-middle">
    <thead class="table-primary">
        <tr>
            <th>ID</th>
            <th>Game</th>
            <th>Player 1</th>
            <th>Player 2</th>
            <th>Winner</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for m in matches %}
        <tr>
            <td>{{ m.id }}</td>
            <td>{{ m.game.game_name }}</td>
            <td class="text-center">
                <img src="{{ url_for('static', filename='uploads/logos/' ~ m.player1.team_logo) }}" 
                     alt="{{ m.player1.team_name }}" class="rounded-circle" style="height:40px; width:40px; object-fit:cover;">
                <div>{{ m.player1.team_name }}</div>
            </td>
            <td class="text-center">
                <img src="{{ url_for('static', filename='uploads/logos/' ~ m.player2.team_logo) }}" 
                     alt="{{ m.player2.team_name }}" class="rounded-circle" style="height:40px; width:40px; object-fit:cover;">
                <div>{{ m.player2.team_name }}</div>
            </td>
            <td>
                {% if m.winner_rel %}
                    <strong>{{ m.winner_rel.team_name }}</strong>
                {% else %}
                    None
                {% endif %}
            </td>
            <td>
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#winnerModal{{ m.id }}">Update Winner</button>
                <a href="{{ url_for('matches.delete', id=m.id) }}" class="btn btn-danger btn-sm">Delete</a>
            </td>
        </tr>

        <!-- Update Winner Modal -->
        <div class="modal fade" id="winnerModal{{ m.id }}" tabindex="-1" aria-labelledby="winnerModalLabel{{ m.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" action="{{ url_for('matches.update_winner', id=m.id) }}">
                        <div class="modal-header">
                            <h5 class="modal-title">Update Winner for Match {{ m.id }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="d-flex justify-content-around align-items-center mb-3">
                                <div>
                                    <img src="{{ url_for('static', filename='uploads/logos/' ~ m.player1.team_logo) }}" 
                                         alt="{{ m.player1.team_name }}" style="height:80px; width:80px; border-radius:50%; object-fit:cover;">
                                    <div>{{ m.player1.team_name }}</div>
                                </div>
                                <div class="fw-bold">VS</div>
                                <div>
                                    <img src="{{ url_for('static', filename='uploads/logos/' ~ m.player2.team_logo) }}" 
                                         alt="{{ m.player2.team_name }}" style="height:80px; width:80px; border-radius:50%; object-fit:cover;">
                                    <div>{{ m.player2.team_name }}</div>
                                </div>
                            </div>
                            <select class="form-select" name="winner" required>
                                <option value="">Select Winner</option>
                                <option value="{{ m.player1.id }}">{{ m.player1.team_name }}</option>
                                <option value="{{ m.player2.id }}">{{ m.player2.team_name }}</option>
                                <option value="draw_loss" disabled>Both Loss</option>
                                <option value="draw_win" disabled>Both Win</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% endfor %}
    </tbody>
</table>

<!-- JS to update Add Match logos dynamically and prevent same player selection -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const player1Select = document.getElementById("player1Select");
    const player2Select = document.getElementById("player2Select");
    const player1Logo = document.getElementById("player1Logo");
    const player2Logo = document.getElementById("player2Logo");

    function updateLogo(selectEl, imgEl) {
        const selectedOption = selectEl.options[selectEl.selectedIndex];
        const logo = selectedOption.getAttribute("data-logo");
        imgEl.src = logo ? logo : "{{ url_for('static', filename='default_logo.png') }}";
    }

    function preventSameSelection() {
        const p1 = player1Select.value;
        const p2 = player2Select.value;
        for (let opt of player1Select.options) {
            opt.disabled = (opt.value === p2 && p2 !== "");
        }
        for (let opt of player2Select.options) {
            opt.disabled = (opt.value === p1 && p1 !== "");
        }
    }

    player1Select.addEventListener("change", () => { updateLogo(player1Select, player1Logo); preventSameSelection(); });
    player2Select.addEventListener("change", () => { updateLogo(player2Select, player2Logo); preventSameSelection(); });
});
</script>
{% endblock %}
